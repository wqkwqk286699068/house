<!DOCTYPE html>
<html lang="en">
 <head> 
  <meta charset="utf-8" /> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /> 
  <meta name="renderer" content="webkit" /> 
  <meta name="author" content="leslie" /> 
  <title>企查查</title> 
  <script type="text/javascript" src="/jquery/js/jquery.min.js"></script> 
  <script type="text/javascript" src="/jquery/js/echarts2.js"></script> 
  <script type="text/javascript" src="/jquery/js/jquery.slimscroll.min.js"></script>
  <script type="text/javascript" src="/jquery/js/require.js"></script>
  <script type="text/javascript" src="/jquery/js/custom.js"></script> 
  <script type="text/javascript">
        var qrcodePolling = false;
    </script> 
 </head> 
 <body> 
  <header class="header navi-header box-shadow "></header> 
  <style type="text/css"> 
    html,body{
        height: 100%;
        background-color: #fff;
    }
   
    .mao-main{
        width: 100%;
    }

    .stock-name{
        color: #fe5151;
    }
    .water-mark{
        position: absolute;
        z-index: 15;
        font-size: 12px;
        color: #aaa;
        text-align: center;
        width: 100%;
        bottom: 20px;
    }

    .bsBox, .bsBox *{
        box-sizing:content-box;
    }
    #save:hover{
        cursor: pointer;
        width:'100px';
        background-color: '#3D73FE';       
    }
  
</style> 

    <button id="save" onclick="saveImg()">保存图片</button>
    <div id="main" class="mao-main" style="height: 100%;width: 100%;"></div>

<script type="text/javascript">

var myChart;
var showKeyNo;
var Text = require('zrender/shape/Text');
var ImageShape = require('zrender/shape/Image');
var Rectangle = require('zrender/shape/Rectangle');
var treeId = 1;
var _currentKeyNo;
var canEditRect = false;
var data;

function getQueryString(name) {   
  location.href.replace("#","");   
  // 如果链接没有参数，或者链接中不存在我们要获取的参数，直接返回空        
  if(location.href.indexOf("?")==-1 || location.href.indexOf(name+'=')==-1)     {           
   return '';       
  }         
   // 获取链接中参数部分        
   var queryString = location.href.substring(location.href.indexOf("?")+1);         
   // 分离参数对 ?key=value&key2=value2        
   var parameters = queryString.split("&");         
  
   var pos, paraName, paraValue;        
   for(var i=0; i<=parameters.length; i++) {   
   // 获取等号位置            
   pos = parameters[i].split('=');            
   if(pos == -1) { continue; }             
   // 获取name 和 value            
   paraName = pos[0];            
   paraValue = pos[1];            
   // 如果查询的name等于当前name，就返回当前值，同时，将链接中的+号还原成空格           
   if(paraName == name) {        
    return decodeURIComponent(paraValue.replace(/\+/g, " "));            
   }        
   }        
  return '';    
}

$(document).ready(function () {
    var json = getQueryString("jsonDate");
    if(json != null && json != '' && json != undefined){
        data = JSON.parse(json);
    }else{
        data = JSON.parse(sessionStorage.getItem('dataMsg'));
    }
    myChart = echarts.init(document.getElementById('main'));
    getData();
});

window.onresize=function(){
}

var rootData;
var gudongData;
var touziData;
var treeNodePadding = 50; //节点间最小间隔
var treeTopPadding = 50; //tree距顶端的距离
var rightNode;//最右侧节点,用于计算偏移量

//处理函数
function getData(){
    $('#load_data').show();  
    rootData = data;
    gudongData = data.gudong;
    touziData = data.touzi;
    transTree(gudongData,1);
    initTree(gudongData);
    transTree(touziData,2);
    initTree(touziData);
    drawGuquan();
    adjustTreeView();
                
}

//计算最左边节点和最右边节点的间隔即为树图宽度
function  getTreeWidth(zr)  {
        var  nodes  =  zr.storage._roots;
        var  max  =  0;
        var  min  =  0;
        for(var  i=0;  i  <  nodes.length;  i++){
                if(nodes[i].type  ==  'image'  ||  nodes[i].type  ==  'icon'){
                        var  nodeX  =  nodes[i].style.x;
                        if(nodeX  >  max){
                                max  =  nodeX;
                                rightNode  =  nodes[i];
                                continue;
                        }
                        if(nodeX  <  min){
                                min  =  nodeX;
                        }
                }
        }
        return max  -  min;
}

//缩放函数
function adjustTreeView(){
    var zr = myChart.getZrender();
    var domWidth = zr.painter.getWidth(); //获取canvas宽度
    var treeWidth = getTreeWidth(zr);
    if (treeWidth <= domWidth){
        var adjustSize = domWidth / treeWidth  * 0.45; //多缩小0.05不至于完全充盈dom
        var lastNodeX = rightNode.style.x * adjustSize;
        var rightOffset = (domWidth - lastNodeX) - (domWidth - treeWidth * adjustSize)/1.22; //尽可能的让其居中
        zr.painter._layers[1].scale = [ adjustSize, adjustSize, 50, 50 ]; //前两个为缩放大小，后两个为缩放原点
        zr.painter._layers[1].position = [rightOffset, treeTopPadding ]; //偏移量
        myChart.refresh();
    }else{
        var adjustSize = domWidth / treeWidth  * 0.6; //多缩小0.05不至于完全充盈dom
        var lastNodeX = rightNode.style.x * adjustSize;
        var rightOffset = (domWidth - lastNodeX) - (domWidth - treeWidth * adjustSize)/1.7; //尽可能的让其居中
        zr.painter._layers[1].scale = [ adjustSize, adjustSize, 50, 50 ]; //前两个为缩放大小，后两个为缩放原点
        zr.painter._layers[1].position = [rightOffset, treeTopPadding ]; //偏移量
        myChart.refresh();
    }  
}

//保存图片
function saveImg(){
    if(isFullScreen()){
      exitFullScreen();
      setTimeout(function() {
        jietu();
      }, 1000);

    }else{
      jietu();
    }
    function jietu(){
        var jietuMask=document.createElement("div");
        $(jietuMask).attr('style','position: fixed; background: #fff; z-index: 1000; top: 0px; bottom: 0px; left: 0px; right: 0px;');
        document.body.appendChild(jietuMask);

        var width = 1926;
        var height = 900;

        var minX = 0;
        var maxX = 0;
        var minY = 300;
        var maxY = 0;
        var moveDown = 0;
        var moveRight = 0;

        var shapeList = myChart.getZrender().storage.getShapeList();
        for(var i=0;i<shapeList.length;i++){
            if(shapeList[i].style&&shapeList[i].style.iconType=='rectangle'){
                if(shapeList[i].style.x>maxX){
                    maxX = shapeList[i].style.x;
                }
                if(shapeList[i].style.x<minX){
                    minX = shapeList[i].style.x;
                }
                if(shapeList[i].style.y>maxY){
                    maxY = shapeList[i].style.y;
                }
                if(shapeList[i].style.y<minY){
                    minY = shapeList[i].style.y;
                }
            }
        }

        if((maxX-minX+300)>width){
            width = maxX-minX+300;
            moveRight = -(maxX+minX-myChart.getZrender().getWidth()+146)/2;
            
        }
        if((maxY-minY+300)>900){
            height = maxY-minY+300;
        }

        moveDown = -(maxY+minY-myChart.getZrender().getHeight())/2-85;
        
        var layer = myChart.getZrender().painter._layers[1];
        var bS = layer.scale.concat();
        var bP = layer.position.concat();

        layer.scale = [1,1,0,0];
        layer.position = [0,0];

        var bW = myChart.getZrender().getWidth();
        var bH = myChart.getZrender().getHeight();

        $('#main').width(width);
        $('#main').height(height);
        
        var zdW = myChart.getZrender().getWidth();
        var zdH = myChart.getZrender().getHeight();
        
        myChart.resize();

        myChart.getZrender().painter.refresh();

        // initZrender(true);

        layer.position[0] = moveRight;
        layer.position[1] = moveDown;

        var shape1 = new Rectangle({
            style: {
                x: -1000-moveRight,
                y: -1000-moveDown,
                width: width+1000,
                height: height+1000,
                color:'#fff'
            } 
        });
        shape1.zlevel=1;
        shape1.z=-2;
        shape1.ndelete = true;
        myChart.getZrender().addShape(shape1);


        for(var i=0;i<width+100;i+=300){
            for(var j=0;j<height+100;j+=228){
                var shapeSy = new ImageShape({
                    style: {
                        image:'/material/theme/chacha/cms/v2/images/shuiying2.png',
                        x: i-moveRight,
                        y: j-moveDown,
                        width:300,
                        height:228
                        
                    }  
                });
                shapeSy.zlevel=1;
                shapeSy.z=-1;
                shapeSy.ndelete = true;
                myChart.getZrender().addShape(shapeSy);
            }
        }

        var shape3 = new Text({
            style: {
                x: width/2-165-moveRight,
                y: height-30-moveDown,
                // text: '股权穿透图由氪度提供',
                strokeColor:'#999',
                color : '#999' ,
                textFont:'normal 12px 微软雅黑',
                lineWidth :0,
            }  
        });
        shape3.zlevel=1;
        shape3.z=-1;
        shape3.ndelete = true;
        myChart.getZrender().addShape(shape3);

        setTimeout(function() {
            var canvas = $('#main canvas')[1];

            var isIE11 = (!!window.ActiveXObject || "ActiveXObject" in window);
            if(isIE11){
                downloadimg(canvas);
            }else{
                download(canvas,'jpg');
            }
            
            $('#main').width('100%');
            $('#main').height(bH);
            myChart.resize();
            layer.scale = bS;
            layer.position = bP;
            myChart.getZrender().render();
            // initZrender();
            $(jietuMask).css('display','none');
        }, 300);
    }
}

//判断数据
function transTree(data,type){
    if(!data) return;
    data.children = data.DetailList;
    data.DetailList = undefined;
    data.treeId = treeId;
    if(type==2){
        data.isTouzi = true;
    }
    var fontSize = 12;
    if(data.ShortStatus=='注销'||data.ShortStatus=='吊销'){
        data.Name = '【'+data.ShortStatus+'】'+data.Name;
    }
    if(data.Name.length>20){
        data.name = data.Name.substr(0,19)+'…';
        data.ltext = true;
    }else{
        data.name = data.Name;
    }
    if(data.Org==2&&data.Name.length>8){
        data.name = data.Name.substr(0,7)+'…';
    }
    data.name = data.name.replace(/(.{10})(?=.)/g, '$1\n');

    if(data.StockRightNum){
        data.subtext = '持股数：'+data.StockRightNum+'';
    }else if(data.ShouldCapi){
        
        data.subtext = '认缴金额：'+data.ShouldCapi;
    }
    if (data.KeyNo) {
        if(data.Tags){
            for(var i=0; i<data.Tags.length; i++){
                if(data.Tags[i].Type==402){
                    data.tag = data.Tags[i].Name;
                }
            }
        }
    }

    if(data.Tags){
        $.each(data.Tags,function(index,vo){
            if(vo.Type==2){
                data.tag = '上市公司';
                data.list = true;
            }else if(vo.Type==1){
                data.tag = '新三板公司';
                data.list = true;
            }else if(vo.Type==401){
                data.tag = '港股上市';
                data.list = true;
            }
        });
    }

    data.editable = true;
    data.symbol = 'rectangle';
    data.symbolSize= [146, 62];
    if(data.tag){
        data.symbolSize= [146, 82];
    }
    data.labelClick = true;
    data.itemStyle =  {
        normal: {
            color: "#fff",
            borderWidth: "1",
            borderColor: "#ccc",
            label: {
                show: true,
                position: "inside",
                textStyle: {
                    fontFamily: "MicroSoft YaHei",
                    fontSize: fontSize,
                    color:'#333',
                    fontStyle: "normal",
                },
            }
        },
        emphasis: {
            color: "rgba(255,255,255,0)",
            borderWidth: "1",
            borderColor: "rgba(255,255,255,0)",
        }
    };

    if(data.Org==2){
        data.symbol = 'rectangle';
        data.clickable = true;
        data.labelClick = false;
        data.symbolSize= [146, 55];
        data.itemStyle =  {
            normal: {
                color: "#F3F9FE",
                borderWidth: "1",
                borderColor: "#128bed",
                label: {
                    show: !0,
                    position: "inside",
                    textStyle: {
                        color:'#333',
                        fontFamily: "MicroSoft YaHei",
                        fontSize: 14,
                        fontStyle: "normal",
                    },
                }
            },
            emphasis: {
                color: "rgba(255,255,255,0)",
                borderWidth: "1",
                borderColor: "rgba(255,255,255,0)",
            }
        };
    }
    
    var children = data.children;
    if(children){
        for(var i=0;i<children.length;i++){
            transTree(children[i],type);
            children[i] = addTampArrow(children[i],fontSize);
        }
    }
    
    if(type==1){
        if(rootData.kzr){
            if(data.KeyNo){
                if(data.KeyNo==rootData.kzr.ControllerData.KeyNo){
                    data.kzr = true;
                }
            }else{
                if(data.Name==rootData.kzr.ControllerData.Name){
                    data.kzr = true;
                }
            }
        }
        if(rootData.syr){
            $.each(rootData.syr.Names,function(index,vo){
                if(data.KeyNo){
                    if(data.KeyNo==vo.KeyNo){
                        data.syr = vo.PercentTotal;
                    }
                }else{
                    if(data.Name==vo.Name){
                        data.syr = vo.PercentTotal;
                    }
                }
            })
        }
    }else if(type==2){
        if(rootData.kg){
            $.each(rootData.kg.Names,function(index,vo){
                if(type==2&&data.KeyNo&&data.KeyNo==vo.KeyNo){
                    data.kg = true;
                }
            })
        }
    }
    treeId++;

}

function addTampArrow(cnode,fontSize){
    var tamp = cnode;
    var Ratio = (!cnode.Percent||cnode.Percent=='0%')?'':cnode.Percent;
    // if(Ratio){
    //     Ratio = (parseFloat(cnode.Percent.substr(0,cnode.Percent.length-1)).toFixed(4))*10000/10000+'%';
    //     tamp.ratio = Ratio;
    // }
    var labelShow = (Ratio != '0%');
    cnode = {
        name:Ratio,
        symbol: "arrowdown",
        symbolSize: [12, 12],
        tooltip: {
            show: !1
        },
        clickable: !1,
        hoverable:false,
        itemStyle: {
            normal: {
                color: "#128bed",
                borderWidth:0,
                label: {
                    show: labelShow,
                    position: "right",
                    textStyle: {
                        fontFamily: "MicroSoft YaHei",
                        fontSize: fontSize,
                        fontStyle: "normal",
                    },
                }
            },
            emphasis: {
                color: "#128bed",
                borderWidth:0,
                label: {
                    show: labelShow,
                    position: "right",
                    textStyle: {
                        fontFamily: "MicroSoft YaHei",
                        fontSize: fontSize,
                        fontStyle: "normal",
                    },
                }
            }
        },
        lineStyle: {
            width: 1,
            color: "#333"
        },
        children:[tamp]
    } 
    return cnode;
}

function initTree(data){
    if(!data) return;
    data.name = data.Name;
    data.editable = false;
    data.labelClick = false;
    data.clickable = false;
    data.symbolSize = [data.name.length*16+80, 52];
    data.symbol = 'rectangle';
    data.itemStyle =  {
            normal: {
                color: "#fff",
                borderWidth: "1",
                borderColor: "#128bed",
                label: {
                    show: !0,
                    position: "inside",
                    textStyle: {
                        color:'#000',
                        fontFamily: "MicroSoft YaHei",
                        fontSize: 16,
                        fontStyle: "normal",
                    },
                }
            },
            emphasis: {
                color: "rgba(255,255,255,0)",
                borderWidth: "1",
                borderColor: "#128bed00",
            }
        };
    getNode(gudongData);
    getNode(touziData);
    function getNode(data){
        if(!data) return; 
        if(data.children){
            for(var i=0;i<data.children.length;i++){
                getNode(data.children[i]);
            }
        }
        if(data.children&&data.children.length>0&&data.KeyNo&&data.KeyNo!=getQueryString("keyNo")){
            data._children = data.children;
            data.children = null;
            data.extend = 1;
            //data.symbol = 'rectangle';
        }
        
    }    

}

//股权穿透图
function drawGuquan(){
    myChart.clear();
    option = {
        title : {
            text: '',
        },
        series : [
            
        ]
    };
    var roam = true;
    if(window.iframe){
        roam = 'move';
    }
    // 向上分支
    if(gudongData){
        option.series.push({
            type: "tree",
            orient: "vertical",
            nodePadding: 25,
            layerPadding: 40,
            symbol:  "circle",
            roam: roam,
            rootLocation: {
                        "x": "50%",
                        "y": "50%"
                    },
            direction:"inverse",
            data: [gudongData]
        });
    }
    // 向下分支
    if(touziData){
        option.series.push({
            type: "tree",
                orient: "vertical",
                nodePadding: 25,
                layerPadding: 40,
                symbol:  "circle",
                roam: roam,
                rootLocation: {
                            "x": "50%",
                            "y": "30%"
                        },
                //direction:"inverse",
                data: [touziData]
        })
    }
    if(gudongData && !touziData){
       option.series[0].rootLocation.y = '65%';
    }
    myChart.setOption(option);
    // initZrender();

    var isDrag;
    var dragStartPos;
    myChart.getZrender().on("mousedown", function (param){   
        isDrag = true;
        dragStartPos = [param.event.x,param.event.y];
        
    });
    myChart.getZrender().on("mouseup", function (param){  
        if(dragStartPos[0]==param.event.x&&dragStartPos[1]==param.event.y){
            isDrag = false; 
        }
        dragStartPos = [];
    });

    //点击上方
    myChart.on('click', function(e){
        if(isDrag) return;
        if((e.data.Org==0||e.data.Org==4||e.data.Org==7||e.data.Org==8||e.data.Org==9)&&e.data.KeyNo&&e.data.KeyNo!=showKeyNo){
            if(e.data.KeyNo[0]=='p'){
                if(window.iframe){
                    window.open('/pl_'+e.data.KeyNo+'.html');
                }else{
                    showKeyNo = e.data.KeyNo;
                    showDetail2(showKeyNo,'company_muhou4','person');
                }
            }else{
                if(window.iframe){
                    window.open('/firm_'+e.data.KeyNo+'.html');
                }else{
                    showKeyNo = e.data.KeyNo;
                    showDetail(showKeyNo,'company_guquan');
                }
            }
        }
        if(e.data.Org==2){
            if(e.data.KeyNo && e.data.KeyNo.length==32){
                if(window.iframe){
                    window.open('/pl_'+e.data.KeyNo+'.html');
                }else{
                    showKeyNo = e.data.KeyNo;
                    showDetail2(showKeyNo,'company_muhou4','person');
                }
            }else{
                window.open('/people?name='+encodeURI(e.data.Name)+'&keyno='+e.data.ParentKeyNo);
            }
        }
    }); 

    //点击下方
    myChart.getZrender().on('click', function(e){
        if(isDrag) return;
        if(e.target&&e.target.clickcom){
            troggleTree(e.target.keyNo,e.target.treeId);
        }
        if(e.target&&e.target.editcom){
            editTree(e.target.keyNo,e.target.treeId);
        }
    }); 

    myChart.on('restore', function(param){
        getNode(gudongData);
        getNode(touziData);
        function getNode(data){
            if(!data) return; 
            if(data.children){
                for(var i=0;i<data.children.length;i++){
                    getNode(data.children[i]);
                }
            }
            if(data.children&&data.children.length>0&&data.KeyNo&&data.KeyNo!=getQueryString("keyNo")){
                data._children = data.children;
                data.children = null;
                data.extend = 1;
                // data.symbol = 'circleCross';
            }
            
        } 
        myChart.setOption(option);
        // initZrender();

    });
}
</script>  
 </body>
</html>